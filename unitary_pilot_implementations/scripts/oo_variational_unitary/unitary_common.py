from unitary_pilot_implementations.multilinear.tensor import einsum
from unitary_pilot_implementations import multilinear as mla
from unitary_pilot_implementations.math_util.convergence import DirectSumDiis
import numpy as np
import re

def simultaneous_step(inter, diagonal_dict):
    # Identify all strings with a t.
    strings = [key[1:] for key in inter if key.startswith("t")]
    # Take Jacobi step
    for string in strings:
        rank = int(re.match("\d*", string).group(0))
        if string == "t1co":
            left = diagonal_dict["c"](inter)
            right = - diagonal_dict["o"](inter)
        elif rank == 1:
            left = diagonal_dict[string[1]](inter)
            right = diagonal_dict[string[2]](inter)
        else:
            left = diagonal_dict["o"](inter)
            right = diagonal_dict["v"](inter)
        hess = 2 * mla.broadcaster(rank, left, right)
        inter[f"t{string}"] += inter[f"r{string}"] / hess
    # Perform DIIS
    new_amps = inter["dsd"].diis(tuple(inter[f"r{string}"] for string in strings),
                        tuple(inter[f"t{string}"] for string in strings))
    # Load the DIIS'd amps into the intermediates
    for string, t in zip(strings, new_amps):
        inter[f"t{string}"] = t

def initialize_intermediates(orbitals, ranks=[2]):
    ncor = sum(x.shape[1] for x in orbitals["c"])
    nocc = sum(x.shape[1] for x in orbitals["o"])
    nvir = sum(x.shape[1] for x in orbitals["v"])
    nfrz = sum(x.shape[1] for x in orbitals["w"])
    intermed = {"dsd": DirectSumDiis(3, 9),
            "t1co": np.zeros((ncor, nocc)), "t1cv": np.zeros((ncor, nvir)), "t1ov": np.zeros((nocc, nvir)),
            "t1cw": np.zeros((ncor, nfrz)), "t1ow": np.zeros((nocc, nfrz)), "t1vw": np.zeros((nvir, nfrz))}
    for rank in ranks:
        intermed[f"t{rank}"] = mla.read_tensor(f"t{rank}", rank, nocc, nvir)
    return intermed

def even_rdm_energy(i):
    # We are assuming quite a few blocks are hermitian, and that rdm_ov is zero.
    # This is rigorously justified for UCC with only even cluster operators.
    # 1RDM terms
    sum_en = einsum("ij, ji", i["h_oo"], i["rdm_oo"]) +einsum("ab, ba", i["h_vv"], i["rdm_vv"]) + i["h_cc"].trace() 
    sum_en += 0.5 * einsum("IJ AB, IJ AB", i["g_oovv"], i["rdm_oovv"])
    sum_en += 0.25 * einsum("IJ KL, IJ KL", i["g_oooo"], i["rdm_oooo"])
    sum_en += 0.25 * einsum("AB CD, AB CD", i["g_vvvv"], i["rdm_vvvv"])
    sum_en += einsum("IA JB, IA JB", i["g_ovov"], i["rdm_ovov"])
    sum_en += 0.25 * einsum("PQ RS, PQ RS", i["g_cccc"], i["rdm_cccc"])
    sum_en += einsum("PQ RS, PQ RS", i["g_coco"], i["rdm_coco"])
    sum_en += einsum("PQ RS, PQ RS", i["g_cvcv"], i["rdm_cvcv"])
    if "rdm_ooov" in i:
        sum_en += einsum("IJ KA, IJ KA", i["g_ooov"], i["rdm_ooov"])
        sum_en += einsum("IA BC, IA BC", i["g_ovvv"], i["rdm_ovvv"])
    return sum_en

def D2_cumulant(i):
    i["c_oooo"] = 1/2 * einsum("IJ ab, KL ab -> KL IJ", i["t2"], i["t2"])
    i["c_ovov"] = -1 * einsum("Ii Ba, Ji Aa -> JB IA", i["t2"], i["t2"]) 
    # Technically, the below term is D1, but D1 DCT will never ever work.
    # d = 0, so the 1RDM is Hartree-Fock, and the cumulant is linear in T.
    # Unconstrained minimization of the energy function leads to a divergent energy of -infinity.
    # ...So this D1 term is included in D2 for convenience.
    i["c_oovv"] = einsum("IJ AB -> IJ AB", i["t2"]).copy()
    i["c_vvvv"] = 1/2 * einsum("ij CD, ij AB -> CD AB", i["t2"], i["t2"])


def D3_cumulant(i):
    temp = -1/3 * einsum("ij Aa, IJ Bb, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/6 * einsum("ij AB, IJ ab, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += temp
    temp = -1/3 * einsum("Ii ab, Jj AB, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/3 * einsum("Ii Aa, Jj Bb, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))

def D4_cumulant(i):
    temp = -1/6 * einsum("Ii ab, Jj cd, ij cd, KL ab -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/3 * einsum("Ii ab, Jj cd, ij ac, KL bd -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/8 * einsum("Ii ab, Jj cd, Ki cd, Lj ab -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/2 * einsum("Ii ab, Jj cd, Kj ac, Li bd -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/6 * einsum("IJ ab, ij ac, ij cd, KL bd -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += temp
    temp = 1/24 * einsum("IJ ab, ij ab, ij cd, KL cd -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += temp
    temp = -1/6 * einsum("IJ ab, Ki cd, ij cd, Lj ab -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/3 * einsum("IJ ab, Ki ac, ij cd, Lj bd -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oooo"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/3 * einsum("ij Ba, Ik bc, ik bc, Jj Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/6 * einsum("ij Ba, Ik bc, ij bc, Jk Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = 2/3 * einsum("ij Ba, Ik bc, ik ab, Jj Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/3 * einsum("ij Ba, Ik bc, ij ab, Jk Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/2 * einsum("ij Ba, Ik bc, Ji bc, jk Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/2 * einsum("ij Ba, Ik bc, Jk ab, ij Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1 * einsum("ij Ba, Ik bc, Ji ab, jk Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/6 * einsum("Ii Ba, ij bc, jk bc, Jk Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/6 * einsum("Ii Ba, jk ab, jk bc, Ji Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/3 * einsum("Ii Ba, ij ab, jk bc, Jk Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = 1/3 * einsum("Ii Ba, Jj bc, jk bc, ik Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/6 * einsum("Ii Ba, Ji bc, jk bc, jk Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = 2/3 * einsum("Ii Ba, Jj ab, jk bc, ik Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/3 * einsum("Ii Ba, Ji ab, jk bc, jk Ac -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_ovov"] += temp
    temp = -1/6 * einsum("ij Ca, kl Db, kl ab, ij AB -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/3 * einsum("ij Ca, kl Db, ik ab, jl AB -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/2 * einsum("ij Ca, kl Db, ik Ab, jl Ba -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/8 * einsum("ij Ca, kl Db, ij Ab, kl Ba -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/6 * einsum("ij CD, ik ab, kl ab, jl AB -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += temp
    temp = 1/24 * einsum("ij CD, ij ab, kl ab, kl AB -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += temp
    temp = -1/6 * einsum("ij CD, kl Aa, kl ab, ij Bb -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/3 * einsum("ij CD, ik Aa, kl ab, jl Bb -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))


def D5_cumulant(i):
    temp = -7/120 * einsum("ij Aa, kl Bb, IJ cd, kl cd, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/120 * einsum("ij Aa, kl Bb, IJ cd, kl bc, ij ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 2/15 * einsum("ij Aa, kl Bb, IJ cd, ik cd, jl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 3/10 * einsum("ij Aa, kl Bb, IJ cd, ik bc, jl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -3/40 * einsum("ij Aa, kl Bb, IJ cd, ij bc, kl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/30 * einsum("ij Aa, Ik bc, Jl Bd, kl bd, ij ac -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 7/60 * einsum("ij Aa, Ik bc, Jl Bd, kl bc, ij ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = -8/15 * einsum("ij Aa, Ik bc, Jl Bd, il bd, jk ac -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 3/5 * einsum("ij Aa, Ik bc, Jl Bd, ik bd, jl ac -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 3/10 * einsum("ij Aa, Ik bc, Jl Bd, il bc, jk ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = -7/30 * einsum("ij Aa, Ik bc, Jl Bd, ik bc, jl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = -3/10 * einsum("ij Aa, Ik bc, Jl Bd, ij bd, kl ac -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 2/15 * einsum("ij Aa, Ik bc, Jl Bd, ij bc, kl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = -1/30 * einsum("ij Aa, IJ Bb, kl bc, kl cd, ij ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/10 * einsum("ij Aa, IJ Bb, ik cd, kl cd, jl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/5 * einsum("ij Aa, IJ Bb, ik bc, kl cd, jl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/40 * einsum("ij Aa, IJ Bb, ij cd, kl cd, kl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/20 * einsum("ij Aa, IJ Bb, ij bc, kl cd, kl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/120 * einsum("ij AB, Ik ab, Jl cd, kl cd, ij ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/15 * einsum("ij AB, Ik ab, Jl cd, kl ac, ij bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/120 * einsum("ij AB, Ik ab, Jl cd, il cd, jk ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/40 * einsum("ij AB, Ik ab, Jl cd, ik cd, jl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/10 * einsum("ij AB, Ik ab, Jl cd, il ac, jk bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("ij AB, IJ ab, kl ac, kl cd, ij bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += temp
    temp = 1/120 * einsum("ij AB, IJ ab, kl ab, kl cd, ij cd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += temp
    temp = -1/20 * einsum("ij AB, IJ ab, ik cd, kl cd, jl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += temp
    temp = 2/15 * einsum("ij AB, IJ ab, ik ac, kl cd, jl bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += temp
    temp = -1/30 * einsum("Ii ab, Jj AB, jk cd, kl cd, il ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/20 * einsum("Ii ab, Jj AB, ik cd, kl cd, jl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/40 * einsum("Ii ab, Jj AB, ij cd, kl cd, kl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("Ii ab, Jj AB, kl ac, kl cd, ij bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/5 * einsum("Ii ab, Jj AB, jk ac, kl cd, il bd -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("Ii Aa, Jj Bb, jk cd, kl cd, il ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 1/10 * einsum("Ii Aa, Jj Bb, kl bc, kl cd, ij ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 1/15 * einsum("Ii Aa, Jj Bb, jk bc, kl cd, il ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = 1/30 * einsum("Ii Aa, Jj Bb, ij cd, kl cd, kl ab -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))
    temp = -2/15 * einsum("Ii Aa, Jj Bb, ik bc, kl cd, jl ad -> IJ AB", i["t2"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["c_oovv"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)), ((0,), (1,)))


def D2_opdm(i):
    i["rdm_oo"] = -1/2 * einsum("Ii ab, Ji ab -> J I", i["t2"], i["t2"])
    i["rdm_vv"] = 1/2 * einsum("ij Ba, ij Aa -> B A", i["t2"], i["t2"])

def D4_opdm(i):
    temp = -1/12 * einsum("Ii ab, ij cd, jk cd, Jk ab -> J I", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oo"] += temp
    temp = 1/6 * einsum("Ii ab, jk ac, jk cd, Ji bd -> J I", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oo"] += temp
    temp = 1/3 * einsum("Ii ab, ij ac, jk cd, Jk bd -> J I", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oo"] += temp
    temp = -1/24 * einsum("Ii ab, jk ab, jk cd, Ji cd -> J I", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oo"] += temp
    temp = -1/12 * einsum("Ii ab, ij ab, jk cd, Jk cd -> J I", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oo"] += temp
    temp = -1/6 * einsum("ij Ba, ik bc, kl bc, jl Aa -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vv"] += temp
    temp = 1/24 * einsum("ij Ba, ij bc, kl bc, kl Aa -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vv"] += temp
    temp = 1/12 * einsum("ij Ba, kl ab, kl bc, ij Ac -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vv"] += temp
    temp = -1/3 * einsum("ij Ba, ik ab, kl bc, jl Ac -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vv"] += temp
    temp = 1/12 * einsum("ij Ba, ij ab, kl bc, kl Ac -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vv"] += temp


def D4_opdm_product(i):
    temp = -1/8 * einsum("Ii ab, Jj cd, Kj cd, Li ab -> KL IJ", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_oooo"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/4 * einsum("ij Ba, Ik bc, Jk bc, ij Aa -> JB IA", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_ovov"] += temp
    temp = -1/8 * einsum("ij Ca, kl Db, kl Ab, ij Ba -> CD AB", i["t2"], i["t2"], i["t2"], i["t2"])
    i["rdm_vvvv"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))


def D2_cumulant_residual(i):
    temp = einsum("IJ ij, ij AB -> IJ AB", i["g_oooo"], i["t2"])
    i["r2"] += temp       
    temp = -2 * einsum("Ia iA, Ji Ba -> IJ AB", i["g_ovov"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = 2 * einsum("IJ AB -> IJ AB", i["g_oovv"])
    i["r2"] += temp
    temp = einsum("ab AB, IJ ab -> IJ AB", i["g_vvvv"], i["t2"])
    i["r2"] += temp

def T2_cumulant_residual(i):
    temp = einsum("ij IJ, Kij ABC -> IJK ABC", i["g_oooo"], i["t3"])
    i["r3"] += mla.antisymmetrize_axes_plus(temp, ((0, 1,), (2,)))
    temp = -2 * einsum("iA Ia, JKi BCa -> IJK ABC", i["g_ovov"], i["t3"])
    i["r3"] += mla.antisymmetrize_axes_plus(temp, ((3,), (4, 5,)), ((2, 1,), (0,)))
    temp = -2 * einsum("IJ iA, Ki BC -> IJK ABC", i["g_ooov"], i["t2"])
    i["r3"] += mla.antisymmetrize_axes_plus(temp, ((3,), (4, 5,)), ((0, 1,), (2,)))
    temp = einsum("ij Ia, Jij ABa -> IJ AB", i["g_ooov"], i["t3"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -2 * einsum("Ia AB, JK Ca -> IJK ABC", i["g_ovvv"], i["t2"])
    i["r3"] += mla.antisymmetrize_axes_plus(temp, ((2, 1,), (0,)), ((5,), (4, 3,)))
    temp = einsum("iA ab, IJi Bab -> IJ AB", i["g_ovvv"], i["t3"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = einsum("AB ab, IJK Cab -> IJK ABC", i["g_vvvv"], i["t3"])
    i["r3"] += mla.antisymmetrize_axes_plus(temp, ((5,), (4, 3,)))

def D3_cumulant_residual(i):
    temp = -2/3 * einsum("ij Aa, IJ Bb, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = -2/3 * einsum("IJ Aa, ij Bb, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = -2/3 * einsum("ij ab, ij Aa, IJ Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = 1/3 * einsum("ij AB, IJ ab, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/3 * einsum("IJ ab, ij AB, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/3 * einsum("ij ab, ij AB, IJ ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -2/3 * einsum("Ii ab, Jj AB, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -2/3 * einsum("Ii AB, Jj ab, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -2/3 * einsum("ij ab, Ii ab, Jj AB -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = 4/3 * einsum("Ii Aa, Jj Bb, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = 2/3 * einsum("ij ab, Ii Aa, Jj Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))

def D4_cumulant_residual(i):
    temp = -1/3 * einsum("Ii jk, jk AB, Jl ab, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/3 * einsum("Ii jk, jk ab, Jl AB, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/3 * einsum("ij kl, ij ab, Ik AB, Jl ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -2/3 * einsum("IJ ij, kl ab, ik ab, jl AB -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 2/3 * einsum("Ii jk, jk Aa, Jl Bb, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/3 * einsum("ij kl, ij ab, Ik Aa, Jl Bb -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/3 * einsum("IJ ij, kl ab, ik Aa, jl Bb -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = einsum("Ii jk, jl AB, Jk ab, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2 * einsum("Ii jk, Jj Aa, kl Bb, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/6 * einsum("IJ ij, ij Aa, kl ab, kl Bb -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/6 * einsum("ij kl, ij ab, IJ Aa, kl Bb -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/12 * einsum("IJ ij, ij ab, kl ab, kl AB -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/12 * einsum("ij kl, ij ab, IJ ab, kl AB -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -2/3 * einsum("ia jA, Ij Ba, Jk bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/3 * einsum("Ia ib, ij ac, Jk AB, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 4/3 * einsum("ia jb, ik bc, Ij AB, Jk ac -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -2/3 * einsum("Ia iA, jk bc, ij bc, Jk Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/3 * einsum("ia jA, jk Ba, IJ bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 2/3 * einsum("Ia ib, Ji ac, jk AB, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -4/3 * einsum("ia jb, ik bc, jk AB, IJ ac -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/3 * einsum("Ia iA, jk bc, Ji bc, jk Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -4/3 * einsum("ia jA, Ij ab, Jk Bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -4/3 * einsum("Ia ib, ij Aa, Jk Bc, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/3 * einsum("ia jb, ik bc, Ij Ac, Jk Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/3 * einsum("Ia iA, jk bc, ij Bb, Jk ac -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/3 * einsum("ia jA, jk ab, IJ Bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -2/3 * einsum("Ia ib, Ji Aa, jk Bc, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -4/3 * einsum("ia jb, ik bc, jk Ac, IJ Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 2/3 * einsum("Ia iA, jk bc, Ji Bb, jk ac -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = einsum("ia jA, Ik Ba, Jj bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2 * einsum("Ia ib, Jj ac, ik AB, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2 * einsum("ia jA, IJ ab, jk Bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1 * einsum("Ia ib, jk Aa, Ji Bc, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2 * einsum("ia jA, Ik ab, Jj Bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2 * einsum("Ia ib, Jj Aa, ik Bc, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/3 * einsum("Ia iA, ij Ba, jk bc, Jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/3 * einsum("ia jb, ik bc, Ik AB, Jj ac -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/3 * einsum("Ia iA, Ji ab, jk bc, jk Bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/3 * einsum("ia jb, ik bc, IJ Ac, jk Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -2/3 * einsum("Ia iA, ij ab, jk bc, Jk Bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/3 * einsum("ia jb, ik bc, Ik Ac, Jj Ba -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/3 * einsum("ab Ac, IJ ab, ij Bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/3 * einsum("ab Ac, ij ab, IJ Bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/3 * einsum("ab cd, ij cd, IJ Aa, ij Bb -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -2/3 * einsum("ab AB, ij cd, ij ac, IJ bd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 2/3 * einsum("ab Ac, Ii ab, Jj Bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/3 * einsum("ab cd, ij cd, Ii Aa, Jj Bb -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/3 * einsum("ab AB, ij cd, Ii ac, Jj bd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2 * einsum("ab Ac, Ii Ba, Jj bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1 * einsum("ab Ac, ij Ba, IJ bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/6 * einsum("ab AB, Ii ab, ij cd, Jj cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/6 * einsum("ab cd, ij cd, Ii AB, Jj ab -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/12 * einsum("ab AB, ij ab, ij cd, IJ cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/12 * einsum("ab cd, ij cd, ij AB, IJ ab -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp

def D5_cumulant_residual(i):
    temp = -7/60 * einsum("ij Aa, IJ Bb, kl cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/60 * einsum("ij Aa, kl Bb, IJ cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/30 * einsum("IJ ab, ij cd, kl AB, kl ac, ij bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -7/30 * einsum("ij ab, kl cd, ij AB, IJ ac, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -7/60 * einsum("ij ab, kl cd, ij cd, kl Aa, IJ Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/30 * einsum("ij Aa, IJ Bb, kl cd, ij bc, kl ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/60 * einsum("IJ ab, ij Ac, kl Bd, kl ad, ij bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/30 * einsum("ij ab, kl cd, ij Ac, IJ Ba, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 4/15 * einsum("ij Aa, Ik Bb, Jl cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 8/15 * einsum("IJ ab, ij cd, kl AB, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 4/15 * einsum("ij ab, kl cd, ij AB, Ik ac, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/15 * einsum("ij ab, kl cd, ij cd, Ik Aa, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 3/5 * einsum("ij Aa, Ik Bb, Jl cd, ij bc, kl ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 3/5 * einsum("IJ ab, ij Ac, kl Bd, ik ad, jl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 3/5 * einsum("ij ab, kl cd, ij Ac, Ik Ba, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -3/10 * einsum("ij Aa, kl Bb, IJ cd, ij bc, kl ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -3/20 * einsum("IJ ab, ij Ac, kl Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -3/10 * einsum("ij ab, kl cd, ij Ac, kl Ba, IJ bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -14/15 * einsum("ij Aa, IJ Bb, kl cd, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 7/15 * einsum("Ii ab, jk Ac, Jl Bd, il ad, jk bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -7/15 * einsum("Ii Aa, jk bc, Jl Bd, il bd, jk ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -7/15 * einsum("ij ab, kl cd, Ii Aa, Jj Bc, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 14/15 * einsum("ij ab, kl cd, ik ac, jl Ad, IJ Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 7/15 * einsum("ij Aa, IJ Bb, kl cd, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 7/15 * einsum("Ii ab, jk cd, Jl AB, il ac, jk bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 7/30 * einsum("Ii Aa, jk Bb, Jl cd, il cd, jk ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 7/15 * einsum("ij ab, kl cd, Ii ac, Jj AB, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 7/15 * einsum("ij ab, kl cd, ik Aa, jl cd, IJ Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -16/15 * einsum("ij Aa, Ik Bb, Jl cd, il ac, jk bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -16/15 * einsum("Ii ab, Jj Ac, kl Bd, ik ad, jl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -16/15 * einsum("Ii Aa, jk bc, Jl Bd, ij bd, kl ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -16/15 * einsum("ij ab, kl cd, Ii Aa, jk Bc, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -16/15 * einsum("ij ab, kl cd, ik ac, Ij Ad, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("ij Aa, Ik Bb, Jl cd, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("Ii ab, jk Ac, Jl Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("Ii Aa, Jj bc, kl Bd, ik bd, jl ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("ij ab, kl cd, ik Aa, Ij Bc, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("ij ab, kl cd, Ii ac, jk Ad, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 3/5 * einsum("ij Aa, Ik Bb, Jl cd, il ab, jk cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -6/5 * einsum("Ii ab, Jj cd, kl AB, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/5 * einsum("Ii Aa, jk Bb, Jl cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 6/5 * einsum("ij ab, kl cd, Ii ac, jk AB, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -3/5 * einsum("ij ab, kl cd, ik Aa, Ij cd, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -7/15 * einsum("ij Aa, Ik Bb, Jl cd, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 14/15 * einsum("Ii ab, jk cd, Jl AB, ij ac, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/15 * einsum("Ii Aa, Jj Bb, kl cd, ik cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -14/15 * einsum("ij ab, kl cd, ik ac, Ij AB, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 7/15 * einsum("ij ab, kl cd, Ii Aa, jk cd, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -6/5 * einsum("ij Aa, kl Bb, IJ cd, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 3/5 * einsum("Ii ab, Jj Ac, kl Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -3/5 * einsum("Ii Aa, Jj bc, kl Bd, ij bd, kl ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -6/5 * einsum("ij ab, kl cd, ik Aa, jl Bc, IJ bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 3/5 * einsum("ij ab, kl cd, Ii ac, Jj Ad, kl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 8/15 * einsum("ij Aa, kl Bb, IJ cd, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 8/15 * einsum("Ii ab, Jj cd, kl AB, ij ac, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 4/15 * einsum("Ii Aa, Jj Bb, kl cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 16/15 * einsum("ij ab, kl cd, ik ac, jl AB, IJ bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 4/15 * einsum("ij ab, kl cd, Ii Aa, Jj cd, kl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/15 * einsum("ij Aa, IJ Bb, kl bc, kl cd, ij ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/15 * einsum("IJ Aa, ij bc, kl bd, kl Bd, ij ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/15 * einsum("ij ab, kl cd, IJ Ac, ij Ba, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/15 * einsum("ij ab, kl Ac, IJ Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/15 * einsum("ij ab, kl Ac, kl cd, ij ad, IJ Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/10 * einsum("ij Aa, Ik Bb, kl cd, Jl cd, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("IJ Aa, ij Bb, ik cd, kl cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/5 * einsum("ij ab, kl cd, Ik AB, ij ac, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/5 * einsum("ij ab, Ik cd, Jl AB, ij ac, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("ij ab, Ik cd, kl cd, ij Aa, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("ij Aa, Ik Bb, kl bc, Jl cd, ij ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/5 * einsum("IJ Aa, ij bc, ik bd, kl Bd, jl ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/5 * einsum("ij ab, kl cd, Ik Ac, ij Ba, Jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("ij ab, Ik Ac, Jl Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/5 * einsum("ij ab, Ik Ac, kl cd, ij ad, Jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/20 * einsum("ij Aa, kl Bb, kl cd, IJ cd, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/20 * einsum("IJ Aa, ij Bb, ij cd, kl cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/10 * einsum("ij ab, kl cd, kl AB, ij ac, IJ bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/10 * einsum("ij ab, IJ cd, kl AB, ij ac, kl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/20 * einsum("ij ab, IJ cd, kl cd, ij Aa, kl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/10 * einsum("ij Aa, kl Bb, kl bc, IJ cd, ij ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/10 * einsum("IJ Aa, ij bc, ij bd, kl Bd, kl ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/10 * einsum("ij ab, kl cd, kl Ac, ij Ba, IJ bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/10 * einsum("ij ab, IJ Ac, kl Bd, ij ad, kl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/10 * einsum("ij ab, IJ Ac, kl cd, ij ad, kl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/30 * einsum("ij AB, IJ ab, kl cd, ik cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -7/60 * einsum("Ii ab, jk AB, Jl cd, il cd, jk ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/60 * einsum("Ii ab, jk cd, Jl AB, il cd, jk ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/60 * einsum("ij ab, kl cd, Ii AB, Jj cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/30 * einsum("ij ab, kl cd, ik cd, jl AB, IJ ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 8/15 * einsum("ij AB, IJ ab, kl cd, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 4/15 * einsum("Ii ab, jk Ac, Jl Bd, il cd, jk ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/15 * einsum("ij ab, kl cd, Ii Ac, Jj Bd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/15 * einsum("ij ab, kl cd, ik Ac, jl Bd, IJ ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -7/60 * einsum("ij AB, Ik ab, Jl cd, il cd, jk ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 7/30 * einsum("Ii ab, Jj AB, kl cd, ik cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -7/30 * einsum("ij ab, kl cd, Ii AB, jk cd, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/20 * einsum("ij AB, Ik ab, Jl cd, ik cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -3/10 * einsum("Ii ab, jk AB, Jl cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/10 * einsum("ij ab, kl cd, ik AB, Ij cd, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 3/5 * einsum("ij AB, Ik ab, Jl cd, il ac, jk bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -3/5 * einsum("Ii ab, Jj Ac, kl Bd, ik cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 3/5 * einsum("ij ab, kl cd, Ii Ac, jk Bd, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/10 * einsum("ij AB, IJ ab, kl ac, kl cd, ij bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/20 * einsum("IJ ab, ij Ac, kl cd, kl Bd, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/20 * einsum("ij ab, kl cd, IJ Ac, ij Bd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/20 * einsum("ij ab, kl Ac, IJ Bd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/20 * einsum("ij ab, kl Ac, kl cd, ij Bd, IJ ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/60 * einsum("ij AB, IJ ab, kl ab, kl cd, ij cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/60 * einsum("IJ ab, ij cd, kl cd, kl AB, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/60 * einsum("ij ab, kl cd, IJ cd, ij AB, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/60 * einsum("ij ab, kl AB, IJ cd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/60 * einsum("ij ab, kl AB, kl cd, ij cd, IJ ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/20 * einsum("ij AB, Ik ab, kl cd, Jl cd, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/10 * einsum("IJ ab, ij AB, ik cd, kl cd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/20 * einsum("ij ab, kl cd, Ik AB, ij cd, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("ij ab, Ik cd, Jl AB, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("ij ab, Ik cd, kl cd, ij AB, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/15 * einsum("ij AB, Ik ab, kl ac, Jl cd, ij bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/15 * einsum("IJ ab, ij Ac, ik cd, kl Bd, jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 2/15 * einsum("ij ab, kl cd, Ik Ac, ij Bd, Jl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/15 * einsum("ij ab, Ik Ac, Jl Bd, ij cd, kl ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/15 * einsum("Ii ab, Jj AB, jk cd, kl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/15 * einsum("Ii AB, jk ab, jl cd, Jl cd, ik ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/15 * einsum("ij ab, kl cd, Ik AB, Ji ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/15 * einsum("ij ab, Ik cd, Jl AB, il ab, jk cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/15 * einsum("ij ab, Ik cd, kl cd, il ab, Jj AB -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("Ii ab, jk AB, jl cd, Jl cd, ik ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/10 * einsum("Ii AB, Jj ab, jk cd, kl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("ij ab, kl cd, Ik AB, il ab, Jj cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/10 * einsum("ij ab, Ik cd, Jl AB, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/10 * einsum("ij ab, Ik cd, kl cd, Ji ab, jl AB -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("Ii ab, jk AB, jk cd, Jl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("Ii AB, jk ab, jk cd, Jl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/20 * einsum("ij ab, kl cd, kl AB, Ii ab, Jj cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/10 * einsum("ij ab, IJ cd, kl AB, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/10 * einsum("ij ab, IJ cd, kl cd, ik ab, jl AB -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/10 * einsum("Ii ab, Jj Ac, kl cd, kl Bd, ij ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("Ii AB, Jj ab, kl ac, kl cd, ij bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/5 * einsum("ij ab, kl cd, IJ Ac, ik ab, jl Bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/5 * einsum("ij ab, kl Ac, IJ Bd, ik ab, jl cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/10 * einsum("ij ab, kl Ac, kl cd, Ii ab, Jj Bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("Ii ab, Jj Ac, jk cd, kl Bd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/5 * einsum("Ii AB, jk ab, jl ac, Jl cd, ik bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/5 * einsum("ij ab, kl cd, Ik Ac, Ji ab, jl Bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("ij ab, Ik Ac, Jl Bd, il ab, jk cd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/5 * einsum("ij ab, Ik Ac, kl cd, il ab, Jj Bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("Ii Aa, Jj Bb, jk cd, kl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/5 * einsum("Ii Aa, jk Bb, jl cd, Jl cd, ik ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/5 * einsum("ij ab, kl cd, Ik AB, Ji ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/5 * einsum("ij ab, Ik cd, Jl AB, il ac, jk bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1/5 * einsum("ij ab, Ik cd, kl cd, il Aa, Jj Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 1/5 * einsum("Ii Aa, Jj Bb, kl bc, kl cd, ij ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/5 * einsum("Ii Aa, Jj bc, kl bd, kl Bd, ij ac -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/5 * einsum("ij ab, kl cd, IJ Ac, ik Ba, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 2/5 * einsum("ij ab, kl Ac, IJ Bd, ik ad, jl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/5 * einsum("ij ab, kl Ac, kl cd, Ii ad, Jj Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/15 * einsum("Ii Aa, Jj Bb, jk bc, kl cd, il ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/15 * einsum("ij ab, kl cd, Ik Ac, Ji Ba, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/15 * einsum("ij ab, Ik Ac, Jl Bd, il ad, jk bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/15 * einsum("Ii Aa, jk Bb, jk cd, Jl cd, il ab -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/15 * einsum("ij ab, kl cd, kl AB, Ii ac, Jj bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 4/15 * einsum("ij ab, IJ cd, kl AB, ik ac, jl bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 2/15 * einsum("ij ab, IJ cd, kl cd, ik Aa, jl Bb -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -8/15 * einsum("Ii Aa, jk Bb, jl bc, Jl cd, ik ad -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -8/15 * einsum("ij ab, kl cd, Ik Ac, il Ba, Jj bd -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -4/15 * einsum("ij ab, Ik Ac, Jl Bd, ik ad, jl bc -> IJ AB", i["g_oovv"], i["t2"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))

def D2_opdm_residual_ucc(i):
    temp = 2 * einsum("I i, Ji AB -> IJ AB", i["f_oo"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -2 * einsum("a A, IJ Ba -> IJ AB", i["f_vv"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))

def D4_opdm_residual_ucc(i):
    temp = 1/3 * einsum("I i, ij AB, jk ab, Jk ab -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/3 * einsum("i j, ik ab, Ik AB, Jj ab -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/3 * einsum("I i, Ji Aa, jk ab, jk Bb -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = 2/3 * einsum("i j, ik ab, IJ Aa, jk Bb -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = -2/3 * einsum("I i, ij Aa, jk ab, Jk Bb -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = 2/3 * einsum("i j, ik ab, Ik Aa, Jj Bb -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = 1/6 * einsum("I i, Ji ab, jk ab, jk AB -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/3 * einsum("i j, ik ab, IJ ab, jk AB -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = 1/3 * einsum("I i, ij ab, jk ab, Jk AB -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/3 * einsum("i j, ik ab, Ik ab, Jj AB -> IJ AB", i["f_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = 1/3 * einsum("a A, Ii Ba, ij bc, Jj bc -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = -2/3 * einsum("a b, ij bc, Ii AB, Jj ac -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/6 * einsum("a A, ij Ba, ij bc, IJ bc -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = 1/3 * einsum("a b, ij bc, ij AB, IJ ac -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/3 * einsum("a A, IJ ab, ij bc, ij Bc -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = 1/3 * einsum("a b, ij bc, IJ Ac, ij Ba -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = 2/3 * einsum("a A, Ii ab, ij bc, Jj Bc -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = -2/3 * einsum("a b, ij bc, Ii Ac, Jj Ba -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((3,), (2,)))
    temp = -1/3 * einsum("a A, ij ab, ij bc, IJ Bc -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))
    temp = 1/3 * einsum("a b, ij bc, ij Ac, IJ Ba -> IJ AB", i["f_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))

# D[odd]_opdm_product_residual is rigorously zero.
# Terms arise from new contributions of the derivative of d w.r.t. to t amplitudes.
# At odd orders with only even cluster operators, d gains no new terms.
# Therefore, its derivative gains no new terms.

def D2_opdm_residual_dct(i):
    temp = 2 * einsum("I i, Ji AB -> IJ AB", i["ft_oo"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = 2 * einsum("a A, IJ Ba -> IJ AB", i["ft_vv"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((3,), (2,)))

def D4_opdm_residual_dct(i):
    temp = -4/3 * einsum("I i, Jj AB, ik ab, jk ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -4/3 * einsum("i j, Ik ab, Jj AB, ik ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/3 * einsum("I i, ij AB, Jk ab, jk ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = 1/3 * einsum("i j, Ij ab, Jk AB, ik ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 2/3 * einsum("I i, Jj Aa, ik Bb, jk ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((2,), (3,)))
    temp = 2/3 * einsum("i j, Ik Aa, Jj Bb, ik ab -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -1/3 * einsum("I i, Ji Aa, jk ab, jk Bb -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)), ((2,), (3,)))
    temp = 2/3 * einsum("i j, ik ab, IJ Aa, jk Bb -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/6 * einsum("I i, Ji ab, jk ab, jk AB -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((1,), (0,)))
    temp = -1/3 * einsum("i j, ik ab, IJ ab, jk AB -> IJ AB", i["ft_oo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -1/3 * einsum("a A, Ii Ba, Jj bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 2/3 * einsum("a b, Ii ac, Jj AB, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = 1/6 * einsum("a A, ij Ba, IJ bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = -1/3 * einsum("a b, IJ ac, ij AB, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += temp
    temp = -2/3 * einsum("a A, Ii ab, Jj Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = -2/3 * einsum("a b, Ii Aa, Jj Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)), ((2,), (3,)))
    temp = 4/3 * einsum("a A, ij ab, IJ Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 4/3 * einsum("a b, IJ Aa, ij Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/3 * einsum("a A, IJ ab, ij Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = 1/3 * einsum("a b, ij Aa, IJ Bc, ij bc -> IJ AB", i["ft_vv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))


def D4_opdm_product_residual_ucc(i):
    temp = -1 * einsum("Ii jk, Jj AB, kl ab, il ab -> IJ AB", i["g_oooo"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = einsum("ia jA, IJ Ba, jk bc, ik bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))
    temp = einsum("Ia ib, jk ac, Ji AB, jk bc -> IJ AB", i["g_ovov"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((0,), (1,)))
    temp = -1 * einsum("ab Ac, IJ Ba, ij bd, ij cd -> IJ AB", i["g_vvvv"], i["t2"], i["t2"], i["t2"])
    i["r2"] += mla.antisymmetrize_axes_plus(temp, ((2,), (3,)))

def D2_d(i):
    temp = -1/2 * einsum("Ii ab, Ji ab -> I J", i["t2"], i["t2"])
    i["d_oo"] = temp
    temp = -1/2 * einsum("ij Aa, ij Ba -> B A", i["t2"], i["t2"])
    i["d_vv"] = temp

def D4_d(i):
    temp = 1/3 * einsum("Ii ab, jk cd, Jj cd, ik ab -> I J", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_oo"] += temp
    temp = -1/12 * einsum("Ii ab, jk cd, ij cd, Jk ab -> I J", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_oo"] += temp
    temp = -1/3 * einsum("Ii ab, jk cd, Jj ac, ik bd -> I J", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_oo"] += temp
    temp = 1/6 * einsum("Ii ab, jk ac, jk cd, Ji bd -> I J", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_oo"] += temp
    temp = -1/24 * einsum("Ii ab, jk ab, jk cd, Ji cd -> I J", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_oo"] += temp
    temp = 1/6 * einsum("ij Aa, kl bc, ik bc, jl Ba -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_vv"] += temp
    temp = -1/24 * einsum("ij Aa, kl bc, ij bc, kl Ba -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_vv"] += temp
    temp = 1/3 * einsum("ij Aa, kl bc, ik ab, jl Bc -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_vv"] += temp
    temp = -1/3 * einsum("ij Aa, kl bc, ij ab, kl Bc -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_vv"] += temp
    temp = -1/12 * einsum("ij Aa, kl bc, kl ab, ij Bc -> B A", i["t2"], i["t2"], i["t2"], i["t2"])
    i["d_vv"] += temp

